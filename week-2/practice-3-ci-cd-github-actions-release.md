# Setting Up CI/CD with GitHub Actions and Release Functionality

In this session, we will guide you through setting up a Continuous Integration and Continuous Deployment (CI/CD) pipeline using GitHub Actions. Additionally, we will add release functionality to your GitHub repository. This setup ensures that every time there's a push or pull request to the `main` branch, your training data is updated, a new linear model is generated, and a release is created automatically. This hands-on approach will help you understand practical CI/CD workflows and release management.

## 1. Creating the GitHub Actions Workflow

We will create a GitHub Actions workflow that triggers on pushes and pull requests to the `main` branch. This workflow will check for changes in the `training_data.csv` file, train a linear model if changes are detected, push the updated model to the `release` branch, and create a new GitHub release.

### .github/workflows/ci-cd.yml

```yaml:
name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Check for changes in training_data.csv
        id: check_changes
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'training_data.csv'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Train Linear Model
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          python train_model.py

      - name: Commit and Push Linear Model to Release Branch
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # First add and commit the model file on main branch
          git add linear_model.txt
          git commit -m "Generate new model"
          
          # Create/checkout an orphan release branch (no history)
          git checkout --orphan temp_release
          
          # Remove everything from the working directory
          git rm -rf .
          
          # Copy only the linear_model.txt from main
          git checkout main -- linear_model.txt
          
          # Add and commit only the model file
          git add linear_model.txt
          git commit -m "Update linear model"
          
          # Force push to release branch
          git push -f origin temp_release:release

      - name: Create GitHub Release
        if: steps.check_changes.outputs.changed == 'true'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: "Automated release generated by CI/CD pipeline."
          draft: false
          prerelease: false

      - name: Upload Release Asset
        if: steps.check_changes.outputs.changed == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./linear_model.txt
          asset_name: linear_model.txt
          asset_content_type: text/plain
```

### Explanation:

- **Triggers (`on`)**: The workflow is triggered on both `push` and `pull_request` events to the `main` branch.
  
- **Jobs**:
  - **Checkout repository**: Uses `actions/checkout@v3` to clone your repository.
  
  - **Set up Python**: Sets up Python version `3.9` using `actions/setup-python@v4`.
  
  - **Install dependencies**: Installs Python dependencies listed in `requirements.txt`.
  
  - **Check for changes in `training_data.csv`**: Determines if `training_data.csv` has been modified in the latest commit.
  
  - **Train Linear Model**: If `training_data.csv` has changed, this step runs the `train_model.py` script to train the model.
  
  - **Commit and Push to Release Branch**: Commits the updated `linear_model.txt` to the `release` branch.
  
  - **Create GitHub Release**: Creates a new GitHub release with a version tag corresponding to the workflow run number.

---




### training_data.csv

Create the file, add content:

```
YearsExperience,Salary
1.1,39343.00
1.3,46205.00
1.5,37731.00
2.0,43525.00
2.2,39891.00
2.9,56642.00
3.0,60150.00
3.2,54445.00
3.2,64445.00
3.7,57189.00
3.9,63218.00
4.0,55794.00
4.0,56957.00
4.1,57081.00
4.5,61111.00
4.9,67938.00
5.1,66029.00
5.3,83088.00
5.9,81363.00
6.0,93940.00
6.8,91738.00
7.1,98273.00
7.9,101302.00
8.2,113812.00
8.7,109431.00
9.0,105582.00
9.5,116969.00
9.6,112635.00
10.3,122391.00
10.5,121872.00
```


## 2. Implementing the Training Script

The `train_model.py` script trains a linear model using the updated `training_data.csv` and outputs the model coefficients to a text file.

### train_model.py

```python
import pandas as pd
from sklearn.linear_model import LinearRegression
import joblib

# Load training data
data = pd.read_csv('training_data.csv')
X = data.iloc[:, :-1]
y = data.iloc[:, -1]

# Train linear model
model = LinearRegression()
model.fit(X, y)

# Save the model
joblib.dump(model, 'linear_model.pkl')

# Save model coefficients to text file
with open('linear_model.txt', 'w') as f:
    f.write(f'Coefficients: {model.coef_}\nIntercept: {model.intercept_}\n')
```

### Explanation:

1. **Loading Data**: The script reads the `training_data.csv` file using `pandas`.
2. **Training the Model**: It trains a `LinearRegression` model using scikit-learn.
3. **Saving the Model**: The trained model is saved as `linear_model.pkl` using `joblib`.
4. **Saving Coefficients**: The model's coefficients and intercept are written to `linear_model.txt`, which will be pushed to the `release` branch.

---

## 3. Adding Dependencies

Ensure that all necessary Python packages are listed in your `requirements.txt` so that the workflow can install them.

### requirements.txt

```text
pandas
scikit-learn
joblib
```

---

## 4. Initializing the Release Branch

Before the workflow can push updates to the `release` branch, ensure that this branch exists in your repository.

### Initializing the Release Branch

```bash
git checkout --orphan release
git rm -rf .
git commit --allow-empty -m "create empty release branch"
git push origin release
```

---

## 5. Configuring GitHub Releases

The workflow is set to automatically create a new release each time the `linear_model.txt` is updated and pushed to the `release` branch. This automates the release process, ensuring that your repository always has the latest model available.

### Key Points:

- **Tagging**: The release is tagged with `v${{ github.run_number }}`, which increments with each workflow run.
  
- **Release Name**: Similarly, the release name corresponds to the tag.

- **Release Body**: A brief description `"Automated release generated by CI/CD pipeline."` is added to the release.

- **Access Token**: The `GITHUB_TOKEN` secret is used to authenticate the release creation.


---

## 6. Testing the CI/CD Pipeline

Modify the `training_data.csv` file, add some new data, and push the changes to the `main` branch.

See what happens in the GitHub Actions tab, as well as the `release` branch, and the release in the GitHub Releases.

---

## Summary

By following these steps, you will have set up a robust CI/CD pipeline using GitHub Actions that:

- **Automates Model Training**: Automatically retrains your linear model whenever `training_data.csv` changes.
  
- **Manages Releases**: Pushes the updated model to the `release` branch and creates a new GitHub release, ensuring that the latest model is always available.


